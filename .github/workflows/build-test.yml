name: Build Test

# This workflow runs on every push and pull request to test that the engine
# compiles successfully on both Windows and Linux platforms. It helps catch
# build issues early before they make it into releases.
#
# Build artifacts are uploaded and retained for 7 days for testing purposes.
# For production releases, see build-release.yml workflow.

on:
  push:
    branches:
      - main
      - develop
      - 'copilot/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  test-windows-build:
    name: Test Windows Build
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3
      
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.20.x'
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 ..
      
      - name: Build Release
        run: |
          cd build
          cmake --build . --config Release --parallel
      
      - name: Verify Build Output
        run: |
          if (Test-Path "build\bin\Release\GameEngine.exe") {
            Write-Host "✓ Build successful: GameEngine.exe created"
            Get-Item build\bin\Release\GameEngine.exe | Format-List
          } else {
            Write-Error "✗ Build failed: GameEngine.exe not found"
            exit 1
          }
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: GameEngine-Windows-Test-${{ github.sha }}
          path: build/bin/Release/GameEngine.exe
          retention-days: 7
  
  test-linux-build:
    name: Test Linux Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libgl1-mesa-dev libglu1-mesa-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
      
      - name: Build Release
        run: |
          cd build
          make -j$(nproc)
      
      - name: Verify Build Output
        run: |
          if [ -f "build/bin/GameEngine" ]; then
            echo "✓ Build successful: GameEngine created"
            ls -lh build/bin/GameEngine
            file build/bin/GameEngine
          else
            echo "✗ Build failed: GameEngine not found"
            exit 1
          fi
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: GameEngine-Linux-Test-${{ github.sha }}
          path: build/bin/GameEngine
          retention-days: 7
