name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-windows:
    name: Build Windows Release (MSVC)
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3
      
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.20.x'
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 ..
      
      - name: Build Release
        run: |
          cd build
          cmake --build . --config Release --parallel
      
      - name: Package Release
        run: |
          mkdir GameEngine-Windows
          
          # Copy executable
          copy build\bin\Release\GameEngine.exe GameEngine-Windows\
          
          # Copy assets
          xcopy /E /I /Y assets GameEngine-Windows\assets
          
          # Copy documentation
          copy README.md GameEngine-Windows\
          copy QUICKSTART.md GameEngine-Windows\
          copy LICENSE GameEngine-Windows\
          
          # Create a simple run script
          echo @echo off > GameEngine-Windows\run.bat
          echo echo ================================ >> GameEngine-Windows\run.bat
          echo echo 3D Game Engine >> GameEngine-Windows\run.bat
          echo echo ================================ >> GameEngine-Windows\run.bat
          echo echo. >> GameEngine-Windows\run.bat
          echo GameEngine.exe >> GameEngine-Windows\run.bat
          
          # Create README for binary distribution
          echo # GameEngine - Pre-built Release > GameEngine-Windows\README_BINARIES.txt
          echo. >> GameEngine-Windows\README_BINARIES.txt
          echo This is a pre-built binary release of the 3D Game Engine. >> GameEngine-Windows\README_BINARIES.txt
          echo No compilation required! >> GameEngine-Windows\README_BINARIES.txt
          echo. >> GameEngine-Windows\README_BINARIES.txt
          echo ## Quick Start >> GameEngine-Windows\README_BINARIES.txt
          echo 1. Double-click run.bat >> GameEngine-Windows\README_BINARIES.txt
          echo 2. Or run GameEngine.exe directly >> GameEngine-Windows\README_BINARIES.txt
          echo. >> GameEngine-Windows\README_BINARIES.txt
          echo ## System Requirements >> GameEngine-Windows\README_BINARIES.txt
          echo - Windows 10/11 (64-bit) >> GameEngine-Windows\README_BINARIES.txt
          echo - OpenGL 3.3+ compatible graphics card >> GameEngine-Windows\README_BINARIES.txt
          echo - Microsoft Visual C++ Redistributable 2022 >> GameEngine-Windows\README_BINARIES.txt
          echo   Download from: https://aka.ms/vs/17/release/vc_redist.x64.exe >> GameEngine-Windows\README_BINARIES.txt
          echo. >> GameEngine-Windows\README_BINARIES.txt
          echo ## Controls >> GameEngine-Windows\README_BINARIES.txt
          echo - WASD - Move camera >> GameEngine-Windows\README_BINARIES.txt
          echo - Mouse - Look around >> GameEngine-Windows\README_BINARIES.txt
          echo - Space - Fly up >> GameEngine-Windows\README_BINARIES.txt
          echo - Left Shift - Fly down >> GameEngine-Windows\README_BINARIES.txt
          echo - F - Toggle wireframe >> GameEngine-Windows\README_BINARIES.txt
          echo - C - Toggle cell shading >> GameEngine-Windows\README_BINARIES.txt
          echo - ` (Grave) - Toggle debug console >> GameEngine-Windows\README_BINARIES.txt
          echo - ESC - Exit >> GameEngine-Windows\README_BINARIES.txt
          echo. >> GameEngine-Windows\README_BINARIES.txt
          echo For source code and development documentation, visit: >> GameEngine-Windows\README_BINARIES.txt
          echo https://github.com/shifty81/GameEngine >> GameEngine-Windows\README_BINARIES.txt
      
      - name: Create ZIP archive
        run: |
          Compress-Archive -Path GameEngine-Windows\* -DestinationPath GameEngine-Windows-x64-MSVC.zip
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameEngine-Windows-x64-MSVC
          path: GameEngine-Windows-x64-MSVC.zip
          retention-days: 90
  
  build-windows-mingw:
    name: Build Windows Release (MinGW)
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.20.x'
      
      - name: Setup MinGW
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          version: 13.2.0
      
      - name: Configure CMake with MinGW
        run: |
          mkdir build-mingw
          cd build-mingw
          cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release ..
      
      - name: Build Release
        run: |
          cd build-mingw
          cmake --build . --config Release -j 4
      
      - name: Package Release
        run: |
          mkdir GameEngine-Windows-MinGW
          
          # Copy executable
          copy build-mingw\bin\GameEngine.exe GameEngine-Windows-MinGW\
          
          # Copy MinGW runtime DLLs (required for distribution)
          $mingwPath = (Get-Command g++).Source | Split-Path
          
          # Check for required MinGW runtime DLLs
          $requiredDlls = @('libgcc_s_seh-1.dll', 'libstdc++-6.dll', 'libwinpthread-1.dll')
          $missingDlls = @()
          
          foreach ($dll in $requiredDlls) {
            $dllPath = Join-Path $mingwPath $dll
            if (Test-Path $dllPath) {
              copy $dllPath GameEngine-Windows-MinGW\
              Write-Host "✓ Copied $dll"
            } else {
              $missingDlls += $dll
              Write-Warning "× Missing $dll at $dllPath"
            }
          }
          
          # Fail if any critical DLLs are missing
          if ($missingDlls.Count -gt 0) {
            Write-Error "Failed to find required MinGW runtime DLLs: $($missingDlls -join ', ')"
            Write-Error "These DLLs are required for the executable to run on systems without MinGW installed"
            exit 1
          }
          
          # Verify at least one critical DLL was copied successfully
          if (-not (Test-Path "GameEngine-Windows-MinGW\libgcc_s_seh-1.dll")) {
            Write-Error "Critical runtime DLL verification failed"
            exit 1
          }
          
          Write-Host "✓ All MinGW runtime DLLs copied successfully"
          
          # Copy assets
          xcopy /E /I /Y assets GameEngine-Windows-MinGW\assets
          
          # Copy documentation
          copy README.md GameEngine-Windows-MinGW\
          copy QUICKSTART.md GameEngine-Windows-MinGW\
          copy BUILD_WITHOUT_VS.md GameEngine-Windows-MinGW\
          copy LICENSE GameEngine-Windows-MinGW\
          
          # Create a simple run script
          echo @echo off > GameEngine-Windows-MinGW\run.bat
          echo echo ================================ >> GameEngine-Windows-MinGW\run.bat
          echo echo 3D Game Engine (MinGW Build) >> GameEngine-Windows-MinGW\run.bat
          echo echo ================================ >> GameEngine-Windows-MinGW\run.bat
          echo echo. >> GameEngine-Windows-MinGW\run.bat
          echo GameEngine.exe >> GameEngine-Windows-MinGW\run.bat
          
          # Create README for binary distribution
          echo # GameEngine - Pre-built Release (MinGW Build) > GameEngine-Windows-MinGW\README_BINARIES.txt
          echo. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo This is a pre-built binary release of the 3D Game Engine. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo Built with MinGW-w64 (GCC compiler) - No Visual Studio runtime required! >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo ## Quick Start >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo 1. Double-click run.bat >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo 2. Or run GameEngine.exe directly >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo ## System Requirements >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - Windows 10/11 (64-bit) >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - OpenGL 3.3+ compatible graphics card >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - NO additional runtime required (MinGW DLLs included) >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo ## Controls >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - WASD - Move camera >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - Mouse - Look around >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - Space - Fly up >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - Left Shift - Fly down >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - F - Toggle wireframe >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - C - Toggle cell shading >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - ` (Grave) - Toggle debug console >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo - ESC - Exit >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo For source code and development documentation, visit: >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo https://github.com/shifty81/GameEngine >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo ## About this Build >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo This version was built with MinGW-w64 (GCC 13.2.0) instead of Visual Studio. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo It includes the necessary MinGW runtime DLLs for distribution. >> GameEngine-Windows-MinGW\README_BINARIES.txt
          echo Performance is comparable to the Visual Studio build. >> GameEngine-Windows-MinGW\README_BINARIES.txt
      
      - name: Create ZIP archive
        run: |
          Compress-Archive -Path GameEngine-Windows-MinGW\* -DestinationPath GameEngine-Windows-x64-MinGW.zip
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameEngine-Windows-x64-MinGW
          path: GameEngine-Windows-x64-MinGW.zip
          retention-days: 90
  
  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libgl1-mesa-dev libglu1-mesa-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
      
      - name: Build Release
        run: |
          cd build
          make -j$(nproc)
      
      - name: Package Release
        run: |
          mkdir GameEngine-Linux
          
          # Copy executable
          cp build/bin/GameEngine GameEngine-Linux/
          
          # Copy assets
          cp -r assets GameEngine-Linux/
          
          # Copy documentation
          cp README.md GameEngine-Linux/
          cp QUICKSTART.md GameEngine-Linux/
          cp LICENSE GameEngine-Linux/
          
          # Create run script
          cat > GameEngine-Linux/run.sh << 'EOF'
          #!/bin/bash
          echo "================================"
          echo "3D Game Engine"
          echo "================================"
          echo ""
          ./GameEngine
          EOF
          chmod +x GameEngine-Linux/run.sh
          chmod +x GameEngine-Linux/GameEngine
          
          # Create README for binary distribution
          cat > GameEngine-Linux/README_BINARIES.txt << 'EOF'
          # GameEngine - Pre-built Release
          
          This is a pre-built binary release of the 3D Game Engine.
          No compilation required!
          
          ## Quick Start
          1. Run ./run.sh
          2. Or run ./GameEngine directly
          
          ## System Requirements
          - Linux (64-bit) - Ubuntu 20.04+ or equivalent
          - OpenGL 3.3+ compatible graphics card
          - Required libraries:
            sudo apt-get install libgl1-mesa-glx libglu1-mesa libx11-6 libxrandr2 libxinerama1 libxcursor1 libxi6
          
          ## Controls
          - WASD - Move camera
          - Mouse - Look around
          - Space - Fly up
          - Left Shift - Fly down
          - F - Toggle wireframe
          - C - Toggle cell shading
          - ` (Grave) - Toggle debug console
          - ESC - Exit
          
          For source code and development documentation, visit:
          https://github.com/shifty81/GameEngine
          EOF
      
      - name: Create TAR archive
        run: |
          tar -czf GameEngine-Linux-x64.tar.gz GameEngine-Linux/
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameEngine-Linux-x64
          path: GameEngine-Linux-x64.tar.gz
          retention-days: 90
  
  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-windows-mingw, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download Windows MSVC artifact
        uses: actions/download-artifact@v4
        with:
          name: GameEngine-Windows-x64-MSVC
      
      - name: Download Windows MinGW artifact
        uses: actions/download-artifact@v4
        with:
          name: GameEngine-Windows-x64-MinGW
      
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: GameEngine-Linux-x64
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            GameEngine-Windows-x64-MSVC.zip
            GameEngine-Windows-x64-MinGW.zip
            GameEngine-Linux-x64.tar.gz
          body: |
            ## 3D Game Engine - Pre-built Binaries
            
            Download and run the engine without needing to compile from source!
            
            ### Downloads
            
            **Windows Users - Choose One:**
            - **GameEngine-Windows-x64-MSVC.zip** - Built with Visual Studio (requires VC++ Redistributable)
            - **GameEngine-Windows-x64-MinGW.zip** - Built with MinGW (no additional runtime needed) ⭐ Recommended
            
            **Linux:**
            - **GameEngine-Linux-x64.tar.gz** - Built with GCC
            
            ### Windows Quick Start (MSVC Build)
            1. Download `GameEngine-Windows-x64-MSVC.zip`
            2. Extract the ZIP file
            3. Install [Visual C++ Redistributable 2022](https://aka.ms/vs/17/release/vc_redist.x64.exe) if not already installed
            4. Run `GameEngine.exe` or `run.bat`
            
            ### Windows Quick Start (MinGW Build) ⭐ Recommended
            1. Download `GameEngine-Windows-x64-MinGW.zip`
            2. Extract the ZIP file
            3. Run `GameEngine.exe` or `run.bat` - No additional runtime needed!
            
            ### Linux Quick Start
            1. Download `GameEngine-Linux-x64.tar.gz`
            2. Extract: `tar -xzf GameEngine-Linux-x64.tar.gz`
            3. Install dependencies: `sudo apt-get install libgl1-mesa-glx libglu1-mesa libx11-6 libxrandr2 libxinerama1 libxcursor1 libxi6`
            4. Run: `./GameEngine-Linux/run.sh`
            
            ### System Requirements
            - **OS**: Windows 10/11 (64-bit) or Linux (64-bit)
            - **Graphics**: OpenGL 3.3+ compatible GPU
            - **RAM**: 2GB minimum, 4GB recommended
            
            ### For Developers
            Want to build from source or contribute? See the [README](https://github.com/shifty81/GameEngine/blob/main/README.md) for development setup instructions.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
